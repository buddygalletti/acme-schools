<html>
  <head>
    <style>
      a {
        margin-right: 20px;
      }
      #navbar {
        background-color: dodgerblue;
        color: white;
        padding: 1.5em;
        font-size: 20px;
      }
      #navbar > a {
        color: white;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.0/react-router-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.1/redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/7.1.0/react-redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux-thunk/2.3.0/redux-thunk.js"></script>
  </head>

  <body>
    <div id="root"></div>
    <script type="text/babel">
      ///////////////////////////////////  CDN STUFF  ///////////////////////////////////////
      // bring in stuff from cdn's
      const { HashRouter, Route, Link, NavLink } = ReactRouterDOM;
      const { createStore, applyMiddleware } = Redux;
      const { Provider, connect } = ReactRedux;

      ///////////////////////////////////  START REDUX  ///////////////////////////////////////

      // define some constants here
      const GET_SCHOOLS = 'GET_SCHOOLS';
      const GET_STUDENTS = 'GET_STUDENTS';
      const ADD_STUDENT = 'ADD_STUDENT';

      // action creators
      const _getSchools = schools => {
        return {
          type: GET_SCHOOLS,
          schools
        };
      };

      const _getStudents = students => {
        return {
          type: GET_STUDENTS,
          students
        };
      };

      const _addStudent = student => {
        return {
          type: ADD_STUDENT,
          student
        };
      };

      // create redux initial state
      const initialState = {
        schools: [],
        students: [],
        school: {},
        student: {
          firstName: '',
          lastName: '',
          email: '',
          gpa: 0.0,
          schoolId: null
        }
      };

      // thunks
      const getSchools = () => {
        return async dispatch => {
          const response = await axios.get('/api/schools/');
          dispatch(_getSchools(response.data));
        };
      };

      const getStudents = () => {
        return async dispatch => {
          const response = await axios.get('/api/students/');
          dispatch(_getStudents(response.data));
        };
      };

      const addStudent = student => {
        console.log(student);
        return async dispatch => {
          const response = await axios.post('/api/students/', student);
          dispatch(_addStudent(response.data));
        };
      };

      // main reducer, think about using combine reducer later
      const reducer = (state = initialState, action) => {
        switch (action.type) {
          case GET_SCHOOLS:
            return {
              ...state,
              schools: action.schools
            };
          case GET_STUDENTS:
            return {
              ...state,
              students: action.students
            };
          case ADD_STUDENT:
            return {
              ...state,
              students: [...state.students, action.student]
            };
          default:
            return state;
        }
      };

      // create redux store
      const store = createStore(reducer, applyMiddleware(ReduxThunk.default));

      /////////////////////////////////////  START REACT  /////////////////////////////////////
      // time for react
      const _NavBar = ({ schools, students }) => {
        const { pathname } = location;
        const activeStyle = {
          fontWeight: 'bold',
          color: 'white',
          textDecoration: 'none'
        };
        return (
          <div id="navbar">
            <NavLink
              to="/"
              activeStyle={{
                ...activeStyle,
                fontSize: '30px',
                marginRight: '3em'
              }}
            >
              ACME Schools
            </NavLink>
            <NavLink to="/schools" activeStyle={activeStyle}>
              Schools ({schools.length})
            </NavLink>
            <NavLink to="/students" activeStyle={activeStyle}>
              Students ({students.length})
            </NavLink>
          </div>
        );
      };
      const NavBar = connect(state => {
        return {
          schools: state.schools,
          students: state.students
        };
      })(_NavBar);

      class _AddStudentForm extends React.Component {
        constructor(props) {
          super(props);

          this.handleChange = this.handleChange.bind(this);
          this.handleSave = this.handleSave.bind(this);
          this.handleSelect = this.handleSelect.bind(this);
        }
        handleChange(ev) {
          this.props.student[ev.target.name] = ev.target.value;
        }
        handleSave(ev) {
          ev.preventDefault();
          this.props.addStudent(this.props.student);
        }
        handleSelect(ev) {
          this.props.student.schoolId = ev.target.value;
        }

        render() {
          const { handleChange, handleSave, handleSelect } = this;
          return (
            <div id="addStudentForm">
              <form onSubmit={handleSave}>
                <label htmlFor="firstName">First name</label>
                <input
                  name="firstName"
                  value={this.props.firstName}
                  onChange={handleChange}
                />
                <br />
                <label htmlFor="lastName">Last name</label>
                <input
                  name="lastName"
                  value={this.props.lastName}
                  onChange={handleChange}
                />
                <br />
                <label htmlFor="email">Email address</label>
                <input
                  name="email"
                  value={this.props.email}
                  onChange={handleChange}
                />
                <br />
                <label htmlFor="gpa">GPA</label>
                <input
                  name="gpa"
                  value={this.props.gpa}
                  onChange={handleChange}
                />
                <br />
                <select value={this.props.schoolId} onChange={handleSelect}>
                  <option>-- Not Enrolled --</option>
                  {this.props.schools.map(school => (
                    <option key={school.id} value={school.id}>
                      {school.name}
                    </option>
                  ))}
                </select>
                <button type="submit">Save</button>
              </form>
            </div>
          );
        }
      }
      const AddStudentForm = connect(
        state => {
          return {
            student: state.student,
            schools: state.schools
          };
        },
        dispatch => {
          return {
            addStudent: student => dispatch(addStudent(student))
          };
        }
      )(_AddStudentForm);

      class _Routes extends React.Component {
        componentDidMount() {
          this.props.loadSchools();
          this.props.loadStudents();
        }
        render() {
          return (
            <HashRouter>
              <Route component={NavBar} />
              <Route path="/" component={AddStudentForm} />
            </HashRouter>
          );
        }
      }
      const Routes = connect(
        null,
        dispatch => {
          return {
            loadSchools: () => dispatch(getSchools()),
            loadStudents: () => dispatch(getStudents())
          };
        }
      )(_Routes);

      const App = () => {
        return (
          <Provider store={store}>
            <Routes />
          </Provider>
        );
      };

      const root = document.querySelector('#root');
      ReactDOM.render(<App />, root);
    </script>
  </body>
</html>
