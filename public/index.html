<html>
  <head>
    <style>
      a {
        margin-right: 20px;
      }
      #navbar {
        background-color: dodgerblue;
        color: white;
        padding: 1.5em;
        font-size: 20px;
      }
      #navbar > a {
        color: white;
      }
      #addStudentForm {
        display: flex;
        justify-content: center;
        margin-top: 2em;
        margin-bottom: 2em;
      }
      #allStudents,
      #allSchools {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
      }
      .studentCard,
      .schoolCard {
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 5px solid dodgerblue;
        border-radius: 25px;
        padding: 50px;
        margin: 50px;
        text-align: center;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.0/react-router-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.1/redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/7.1.0/react-redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux-thunk/2.3.0/redux-thunk.js"></script>
  </head>

  <body>
    <div id="root"></div>
    <script type="text/babel">
      ///////////////////////////////////  STAT FUNCTIONS  ///////////////////////////////////////

      const mostPopularSchool = (students = [], schools = []) => {
        // this does not deal with ties
        const enrollment = {};
        schools.forEach(school => {
          enrollment[school.id] = {
            id: school.id,
            name: school.name,
            enrolled: 0
          };
        });
        students.forEach(student => {
          if (student.schoolId) {
            enrollment[student.schoolId].enrolled++;
          }
        });
        const stats = Object.values(enrollment);
        let max = 0;
        let mostPopularName;
        let mostPopularId;
        for (let i = 0; i < stats.length; i++) {
          if (stats[i].enrolled > max) {
            max = stats[i].enrolled;
            mostPopularName = stats[i].name;
            mostPopularId = stats[i].id;
          }
        }
        // TODO return schoool id with it also. add to return
        // const foundSchool = schools.find(school => mostPopular === school.name);
        // const mostPopularId = foundSchool.id;

        return {
          mostPopularName,
          mostPopularId,
          max
        };
      };

      const studentCount = (schoolId, students) => {
        const countsById = {};
        for (let i = 0; i < students.length; i++) {
          let student = students[i];
          if (Object.keys(countsById).includes(student.schoolId)) {
            countsById[student.schoolId]++;
          } else {
            countsById[student.schoolId] = 1;
          }
        }
        return countsById[schoolId];
      };

      ///////////////////////////////////  CDN STUFF  ///////////////////////////////////////
      // bring in stuff from cdn's
      const { HashRouter, Route, Link, NavLink } = ReactRouterDOM;
      const { createStore, applyMiddleware } = Redux;
      const { Provider, connect } = ReactRedux;

      ///////////////////////////////////  START REDUX  ///////////////////////////////////////

      // define some constants here
      const GET_SCHOOLS = 'GET_SCHOOLS';
      const GET_STUDENTS = 'GET_STUDENTS';
      const ADD_STUDENT = 'ADD_STUDENT';
      const DESTROY_STUDENT = 'DESTROY_STUDENT';
      const UPDATE_STUDENT = 'UPDATE_STUDENT';

      // action creators
      const _getSchools = schools => {
        return {
          type: GET_SCHOOLS,
          schools
        };
      };

      const _getStudents = students => {
        return {
          type: GET_STUDENTS,
          students
        };
      };

      const _addStudent = student => {
        return {
          type: ADD_STUDENT,
          student
        };
      };

      const _destroyStudent = id => {
        return {
          type: DESTROY_STUDENT,
          id
        };
      };

      const _updateStudent = student => {
        return {
          type: UPDATE_STUDENT,
          studentId: student.id,
          newSchoolId: student.schoolId
        };
      };

      // create redux initial state
      const initialState = {
        schools: [],
        students: [],
        school: {},
        student: {
          firstName: '',
          lastName: '',
          email: '',
          gpa: 0.0,
          schoolId: null
        }
      };

      // thunks
      const getSchools = () => {
        return async dispatch => {
          const response = await axios.get('/api/schools/');
          dispatch(_getSchools(response.data));
        };
      };

      const getStudents = () => {
        return async dispatch => {
          const response = await axios.get('/api/students/');
          dispatch(_getStudents(response.data));
        };
      };

      const addStudent = student => {
        return async dispatch => {
          const response = await axios.post('/api/students/', student);
          dispatch(_addStudent(response.data));
        };
      };

      const destroyStudent = id => {
        return async dispatch => {
          const response = await axios.delete(`/api/students/${id}`);
          dispatch(_destroyStudent(response.data));
        };
      };

      const updateStudent = (studentId, schoolId) => {
        return async dispatch => {
          const response = await axios.put(
            `/api/students/${studentId}`,
            schoolId
          );
          dispatch(_updateStudent(response.data));
        };
      };

      // main reducer, think about using combine reducer later
      const reducer = (state = initialState, action) => {
        switch (action.type) {
          case GET_SCHOOLS:
            return {
              ...state,
              schools: action.schools
            };
          case GET_STUDENTS:
            return {
              ...state,
              students: action.students
            };
          case ADD_STUDENT:
            return {
              ...state,
              students: [...state.students, action.student]
            };
          case DESTROY_STUDENT:
            const studentsAfterDelete = state.students.filter(
              student => action.id !== student.id
            );
            return {
              ...state,
              students: [...studentsAfterDelete]
            };
            return {
              ...state,
              mostPopular: { ...getMostPopularSchool }
            };
          // TODO this is not finished
          case UPDATE_STUDENT:
            const students = state.students.map(student => {
              if (student.id === action.studentId) {
                return { ...student, schoolId: action.newSchoolId };
              } else {
                return student;
              }
            });
            return { ...state, students };
          default:
            return state;
        }
      };

      // create redux store
      const store = createStore(reducer, applyMiddleware(ReduxThunk.default));

      /////////////////////////////////////  START REACT  /////////////////////////////////////
      // time for react
      const _NavBar = props => {
        const { schools, students, mostPopular } = props;
        const mostPopularStats = mostPopular(students, schools);
        const activeStyle = {
          fontWeight: 'bold',
          color: 'white',
          textDecoration: 'none'
        };
        return (
          <div id="navbar">
            <NavLink
              to="/"
              activeStyle={{
                ...activeStyle,
                fontSize: '30px',
                marginRight: '3em'
              }}
            >
              ACME Schools
            </NavLink>
            <NavLink to="/schools" activeStyle={activeStyle}>
              Schools ({schools.length})
            </NavLink>
            <NavLink to="/students" activeStyle={activeStyle}>
              Students ({students.length})
            </NavLink>
            <NavLink
              to={`/students/${mostPopularStats.mostPopularId}`}
              activeStyle={activeStyle}
            >
              Most Popular {mostPopularStats.mostPopularName} (
              {mostPopularStats.max})
            </NavLink>
          </div>
        );
      };
      const NavBar = connect(state => {
        return {
          schools: state.schools,
          students: state.students,
          mostPopular: mostPopularSchool
        };
      })(_NavBar);

      class _AddStudentForm extends React.Component {
        constructor(props) {
          super(props);

          this.handleChange = this.handleChange.bind(this);
          this.handleSave = this.handleSave.bind(this);
          this.handleSelect = this.handleSelect.bind(this);
        }
        handleChange(ev) {
          this.props.student[ev.target.name] = ev.target.value;
        }
        handleSave(ev) {
          ev.preventDefault();
          this.props.addStudent(this.props.student);
          this.props.location.hash = `/schools/${this.props.student.schoolId}`;
        }
        handleSelect(ev) {
          this.props.student.schoolId = ev.target.value;
        }

        render() {
          const { handleChange, handleSave, handleSelect } = this;
          return (
            <div id="form-container">
              <div id="addStudentForm">
                <form onSubmit={handleSave}>
                  <label htmlFor="firstName">First name &rarr; </label>
                  <input
                    name="firstName"
                    value={this.props.firstName}
                    onChange={handleChange}
                  />
                  <br />
                  <label htmlFor="lastName">Last name &rarr; </label>
                  <input
                    name="lastName"
                    value={this.props.lastName}
                    onChange={handleChange}
                  />
                  <br />
                  <label htmlFor="email">Email address &rarr; </label>
                  <input
                    name="email"
                    value={this.props.email}
                    onChange={handleChange}
                  />
                  <br />
                  <label htmlFor="gpa">GPA &rarr; </label>
                  <input
                    name="gpa"
                    value={this.props.gpa}
                    onChange={handleChange}
                  />
                  <br />
                  Enroll at &rarr;{' '}
                  <select value={this.props.schoolId} onChange={handleSelect}>
                    <option>-- Not Enrolled --</option>
                    {this.props.schools.map(school => (
                      <option key={school.id} value={school.id}>
                        {school.name}
                      </option>
                    ))}
                  </select>
                  <br />
                  <br />
                  <button type="submit">Save</button>
                </form>
              </div>
              <div>
                <hr />
              </div>
            </div>
          );
        }
      }
      const AddStudentForm = connect(
        state => {
          return {
            student: state.student,
            schools: state.schools
          };
        },
        dispatch => {
          return {
            addStudent: student => dispatch(addStudent(student))
          };
        }
      )(_AddStudentForm);

      class _Students extends React.Component {
        constructor(props) {
          super(props);
        }

        render() {
          const {
            students,
            schools,
            destroyStudent,
            updateStudent
          } = this.props;
          let school;
          return (
            <div id="allStudents">
              {students.map(student => {
                if (student.schoolId) {
                  school = schools.find(function(school) {
                    return school.id === student.schoolId;
                  });
                }
                return (
                  // need to change this to StudentCard component maybe
                  <div className="studentCard" key={student.id}>
                    <h5>{`${student.firstName} ${student.lastName}`}</h5>
                    <img src={school.imageUrl} />
                    <br />
                    <p>
                      GPA:{' '}
                      {parseFloat(Math.round(student.gpa * 100) / 100).toFixed(
                        2
                      )}
                    </p>
                    <select
                      defaultValue={school.id}
                      onChange={ev =>
                        updateStudent(student.id, ev.target.value)
                      }
                    >
                      <option>Not Enrolled</option>
                      {schools.map(school => (
                        <option key={school.name} value={school.id}>
                          {school.name}
                        </option>
                      ))}
                    </select>
                    <br />
                    <button onClick={() => destroyStudent(student.id)}>
                      Destroy Student
                    </button>
                  </div>
                );
              })}
            </div>
          );
        }
      }
      const Students = connect(
        state => {
          return {
            students: state.students,
            schools: state.schools
          };
        },
        dispatch => {
          return {
            destroyStudent: student => dispatch(destroyStudent(student)),
            updateStudent: (studentId, schoolId) =>
              dispatch(updateStudent(studentId, schoolId))
          };
        }
      )(_Students);

      class _Schools extends React.Component {
        constructor(props) {
          super(props);
          console.log(props);
        }

        render() {
          const { students, schools, count } = this.props;

          return (
            <div id="allSchools">
              {schools.map(school => {
                return (
                  <div className="schoolCard" key={school.id}>
                    <h5>
                      <Link to={`/schools/${school.id}`}>{school.name}</Link>
                    </h5>
                    <img src={school.imageUrl} />
                    <br />
                    <p>
                      Student Count{' '}
                      {count(school.id, students)
                        ? count(school.id, students)
                        : 0}
                    </p>
                    <br />
                  </div>
                );
              })}
            </div>
          );
        }
      }
      const Schools = connect(
        state => {
          return {
            students: state.students,
            schools: state.schools,
            count: studentCount
          };
        },
        dispatch => {
          return {};
        }
      )(_Schools);

      /////////////////////////////////////  ROUTES && APP  /////////////////////////////////////

      class _Routes extends React.Component {
        componentDidMount() {
          this.props.loadSchools();
          this.props.loadStudents();
        }
        render() {
          return (
            <HashRouter>
              <Route component={NavBar} />
              <Route path="/" component={AddStudentForm} />
              <Route path="/students" exact component={Students} />
              <Route path="/schools" exact component={Schools} />
            </HashRouter>
          );
        }
      }
      const Routes = connect(
        null,
        dispatch => {
          return {
            loadSchools: () => dispatch(getSchools()),
            loadStudents: () => dispatch(getStudents())
          };
        }
      )(_Routes);

      const App = () => {
        return (
          <Provider store={store}>
            <Routes />
          </Provider>
        );
      };

      const root = document.querySelector('#root');
      ReactDOM.render(<App />, root);
    </script>
  </body>
</html>
